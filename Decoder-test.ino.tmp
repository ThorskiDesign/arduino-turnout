/*

This file is part of Arduino Turnout
Copyright (C) 2017-2018 Eric Thorstenson

Arduino Turnout is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Arduino Turnout is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.

*/

#include "DCCpacket.h"
#include "Bitstream.h"
#include <EEPROM.h>
#include <Servo.h>
#include "DCCdecoder.h"


// Bitstream setup ==========================================================================

// global stuff
const byte intPin = 8;
//BitStream bitStream(intPin, false, false, 48, 68, 88, 10000, 10);
BitStream bitStream(intPin, false);
DCCpacket dccpacket(true, true, 250);
DCCdecoder dcc;


// called when the next 32 bits from the bitstream are ready
void BitStreamHandler(unsigned long incomingBits)
{
	dccpacket.ProcessIncomingBits(incomingBits);
}


void BitErrorHandler(byte errorCode)
{
    //Serial.print("Bit error, code: ");
    //Serial.println(errorCode,DEC);
}


// called when an assembled packet is ready
void MainPacketHandler(byte *packetData, byte size)
{
	dcc.ProcessPacket(packetData, size);
}


void MainPacketErrorHandler(byte errorCode)
{
    Serial.print("Packet error, code: ");
    Serial.println(errorCode,DEC);
}


void DCC_AccessoryDecoderHandler(int boardAddress, int outputAddress, byte activate, byte data)
{
    Serial.print("Basic Acc Packet, Board Address: ");
    Serial.print(boardAddress, DEC);
    Serial.print("  Output Address: ");
    Serial.print(outputAddress, DEC);
    Serial.print("  Activate Bit: ");
    Serial.print(activate,DEC);
    Serial.print("  Data: ");
    Serial.println(data,DEC);
}


void DCC_ExtendedAccDecoderHandler(int boardAddress, int outputAddress, byte data)
{
    Serial.print("Ext Acc Packet, Board Address: ");
    Serial.print(boardAddress, DEC);
    Serial.print("  Output Address: ");
    Serial.print(outputAddress, DEC);
    Serial.print("  Data: ");
    Serial.println(data,DEC);
}


void DCC_BaselineControlHandler(int address, int speed, int direction)
{
    Serial.print("Baseline Packet, Loco Address: ");
    Serial.print(address, DEC);
    Serial.print("  Speed: ");
    Serial.print(speed, DEC);
    Serial.print("  Direction: ");
    Serial.println(direction,DEC);
}


void DCC_AccPomHandler(int boardAddress,int outputAddress, byte instructionType, int cv, byte data)
{
    Serial.print("Basic Acc POM Packet, Board Address: ");
    Serial.print(boardAddress, DEC);
    Serial.print("  Output Address: ");
    Serial.print(outputAddress, DEC);
    Serial.print("  Instruction Type: ");
    Serial.print(instructionType,DEC);
    Serial.print("  CV: ");
    Serial.print(cv,DEC);
    Serial.print("  Data: ");
    Serial.println(data,DEC);
}




// Setup  =================================================================
//
void setup()
{
	//pinMode(0, OUTPUT);
	//pinMode(1, OUTPUT);

	Serial.begin(115200);

    bitStream.SetDataFullHandler(&BitStreamHandler);
    bitStream.SetErrorHandler(&BitErrorHandler);
	Serial.println("bitstream setup complete.");

    dccpacket.SetPacketCompleteHandler(&MainPacketHandler);
    dccpacket.SetPacketErrorHandler(&MainPacketErrorHandler);
	Serial.println("packet builder setup complete.");

    dcc.SetupDecoder(0,0,0,true);
    dcc.SetBasicAccessoryDecoderPacketHandler(&DCC_AccessoryDecoderHandler);
    dcc.SetExtendedAccessoryDecoderPacketHandler(&DCC_ExtendedAccDecoderHandler);
    dcc.SetBaselineControlPacketHandler(&DCC_BaselineControlHandler);
    dcc.SetBasicAccessoryPomPacketHandler(&DCC_AccPomHandler);
	Serial.println("dcc decoder setup complete.");

	bitStream.Resume();    // start the bitstream capture
	Serial.println("bitstream capture started.");
}



// Main loop   =======================================================================

void loop()
{
	bitStream.ProcessTimestamps();
}
